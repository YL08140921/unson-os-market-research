# Instagram ペルソナ分析改善計画
**ブランチ**: `feature/improve-instagram-persona-analysis`
**作成日**: 2025-10-10
**ステータス**: 計画フェーズ（実装未開始）

---

## 📋 プロジェクト概要

### 目的
Nemotron-Personas-Japan データセットを活用して、Instagram ペルソナ分析の精度と信頼性を向上させる。

### 背景
現在の実装では、Instagram API (Apify) から直接ハッシュタグ検索でペルソナを生成しているが、以下の課題がある:
- **ターゲット精度の低さ**: ハッシュタグ検索では意図したターゲット層以外のデータも混在
- **デモグラフィック情報の不足**: Instagram データだけでは年齢・居住地・職業などが推測ベース
- **日本市場への特化不足**: グローバルデータが混在し、日本の文化的文脈が弱い

### 期待される成果
- **ペルソナ精度向上**: 統計的に裏付けられた日本人ペルソナの生成
- **ターゲティング改善**: Nemotron データセットで事前にペルソナ属性を定義してから Instagram で検証
- **文化的妥当性**: 日本の人口統計・職業分布に基づいた現実的なペルソナ

---

## 🔍 調査結果サマリー

### 現在のフロー (Approach A: Instagram 直接)
```
ユーザー入力
  ↓
ハッシュタグ検索 (#smallbusiness 等)
  ↓
Apify Instagram API 実行
  ↓
投稿データ収集 (623 profiles, 888 posts)
  ↓
手動分析・ペルソナ生成
```

**長所**:
- ✅ 実在ユーザーの実際の行動データ
- ✅ リアルタイムのトレンド反映
- ✅ エンゲージメント指標が正確

**短所**:
- ❌ ハッシュタグ検索では意図しないユーザーも混在
- ❌ デモグラフィック情報が推測ベース
- ❌ 日本市場に特化していない
- ❌ 統計的裏付けが弱い

### 提案フロー (Approach B: Nemotron 経由で Instagram 特定)
```
ユーザー入力
  ↓
Nemotron-Personas-Japan クエリ
  ↓
統計的に正確なペルソナベース取得
  ↓
ペルソナ属性 → Instagram 検索キーワード生成
  ↓
Apify Instagram API 実行（ターゲット絞込）
  ↓
Nemotron ペルソナ + Instagram 実データ統合
```

**長所**:
- ✅ 統計的に裏付けられた日本人ペルソナ
- ✅ 22 フィールドの詳細なデモグラフィック情報
- ✅ 1,500+ 職業カテゴリー、全 47 都道府県カバー
- ✅ Instagram データで実在性を検証・補強
- ✅ 日本の人口統計に基づいた現実的分布

**短所**:
- ⚠️ 新しい依存関係 (Hugging Face datasets ライブラリ)
- ⚠️ データセットサイズ 1.73GB (初回ダウンロード時間)
- ⚠️ Instagram 検索キーワード生成ロジックの複雑化

---

## 🏗️ 統合アーキテクチャ設計

### アーキテクチャ方針
**ハイブリッドアプローチ**: Nemotron-Personas-Japan と Instagram API の組み合わせ

### システム構成
```
┌─────────────────────────────────────────────┐
│  ユーザー入力 (抽象的ターゲット記述)         │
└────────────────┬────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────┐
│  Phase 1: Nemotron ペルソナ選定             │
│  - HuggingFace datasets API                 │
│  - フィルタリング (職業/年齢/地域)          │
│  - 統計的に妥当な 3-5 ペルソナ抽出         │
└────────────────┬────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────┐
│  Phase 2: Instagram 検索キーワード生成      │
│  - Nemotron フィールドから検索語抽出       │
│  - Occupation → 職業関連ハッシュタグ       │
│  - Hobbies → 趣味関連ハッシュタグ          │
│  - Skills → スキル関連キーワード           │
└────────────────┬────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────┐
│  Phase 3: Instagram データ収集              │
│  - Apify Instagram API 実行                 │
│  - ペルソナごとに絞り込んだ検索            │
│  - 実在ユーザーの投稿・エンゲージメント    │
└────────────────┬────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────┐
│  Phase 4: データ統合・検証                  │
│  - Nemotron 基礎情報 + Instagram 実データ  │
│  - 矛盾チェック (年齢/職業の整合性)        │
│  - エンリッチメント (実際の言葉遣い等)     │
└────────────────┬────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────┐
│  Phase 5: ペルソナドキュメント生成          │
│  - 統計的裏付け + 実在データの融合         │
│  - 信頼性スコア算出                         │
│  - 出力: persona_profiles.md               │
└─────────────────────────────────────────────┘
```

### データフロー
1. **入力**: "20代のIT業界転職検討者"
2. **Nemotron クエリ**: Age=20-29, Occupation LIKE '%IT%', Career Goals LIKE '%転職%'
3. **抽出結果**: 3-5 ペルソナ (26歳 SE、28歳 デザイナー等)
4. **Instagram キーワード**: #ITエンジニア, #転職活動, #キャリアチェンジ
5. **Instagram データ**: 実在ユーザー投稿 50+ 件
6. **統合**: Nemotron デモグラフィック + Instagram 実際の悩み/価値観

---

## 📐 実装計画 (段階的アプローチ)

### Phase 1: 環境セットアップ (1-2h)
**目標**: Nemotron-Personas-Japan データセットへのアクセス確立

**タスク**:
1. `datasets` ライブラリのインストール
   ```bash
   pip install datasets
   ```
2. データセット読み込みテスト
   ```python
   from datasets import load_dataset
   ds = load_dataset("nvidia/Nemotron-Personas-Japan", split="train")
   print(ds[0])  # サンプル確認
   ```
3. データ構造の把握とフィールドマッピング定義
4. キャッシュ設定 (初回 1.73GB ダウンロード対応)

**成功基準**:
- ✅ データセット正常読み込み
- ✅ 全 22 フィールドへのアクセス確認
- ✅ サンプルペルソナ 10 件抽出成功

---

### Phase 2: Nemotron クエリモジュール開発 (2-3h)
**目標**: ユーザー入力から適切な Nemotron ペルソナを抽出

**タスク**:
1. クエリビルダー実装
   - 年齢範囲 → Age フィールドフィルタ
   - 職業キーワード → Occupation LIKE 検索
   - 地域 → Prefecture/Region フィルタ
2. ペルソナ選定ロジック
   - スコアリング (入力との関連度)
   - 多様性確保 (似たペルソナの排除)
   - 3-5 件の最適なペルソナ抽出
3. テストケース作成
   - "20代IT転職検討者" → 期待ペルソナ
   - "30代主婦起業家" → 期待ペルソナ

**ファイル**:
- `lib/nemotron_persona_selector.py`
- `tests/test_nemotron_selector.py`

**成功基準**:
- ✅ 5 種類の入力パターンで適切なペルソナ抽出
- ✅ 統計的裏付けのある属性値 (年齢/職業/地域)
- ✅ 処理時間 < 3 秒

---

### Phase 3: Instagram キーワード生成ロジック (2-3h)
**目標**: Nemotron ペルソナ属性から Instagram 検索キーワードを自動生成

**タスク**:
1. フィールド → ハッシュタグマッピング定義
   ```python
   {
     "Occupation": ["#エンジニア", "#SE", "#プログラマー"],
     "Hobbies": ["#旅行好き", "#カメラ", "#読書"],
     "Skills": ["#Python", "#デザイン思考"]
   }
   ```
2. キーワード優先順位付け
   - Primary: Occupation + Career Goals
   - Secondary: Hobbies + Interests
   - Tertiary: Skills + Cultural Background
3. 日本語/英語ハッシュタグの組み合わせ最適化

**ファイル**:
- `lib/instagram_keyword_generator.py`
- `config/keyword_mapping.json`

**成功基準**:
- ✅ ペルソナごとに 5-10 個の関連キーワード生成
- ✅ 日本語ハッシュタグ優先 (日本市場特化)
- ✅ 既存の Instagram 検索で結果が返ること確認

---

### Phase 4: 統合ペルソナ分析エージェント改修 (3-4h)
**目標**: 既存の `persona-analyzer` エージェントに Nemotron 統合

**タスク**:
1. エージェントフロー変更
   ```
   OLD: ユーザー入力 → Instagram 検索 → ペルソナ生成
   NEW: ユーザー入力 → Nemotron 選定 → Instagram 検索 → 統合
   ```
2. データ統合ロジック実装
   - Nemotron ベースライン (年齢/職業/居住地)
   - Instagram エンリッチメント (実際の言葉遣い/悩み/トレンド)
   - 矛盾検出 (年齢と投稿内容の不一致等)
3. 信頼性スコア算出
   - Nemotron 統計的裏付け: +40 点
   - Instagram 実データ検証: +40 点
   - 整合性: +20 点
4. 出力フォーマット更新 (Nemotron 出典明記)

**ファイル**:
- `.claude/agents/001-persona-analyzer.md` (更新)
- `lib/persona_integrator.py` (新規)

**成功基準**:
- ✅ Nemotron + Instagram 統合ペルソナ生成
- ✅ 信頼性スコア 80+ 点
- ✅ 実データ 100% 使用保証維持

---

### Phase 5: 品質保証・ドキュメント整備 (2h)
**目標**: 新フローの品質検証と利用ドキュメント作成

**タスク**:
1. E2E テスト実施
   - 3 種類の異なるターゲット入力
   - ペルソナ品質の目視確認
   - 処理時間計測 (目標: < 60 秒)
2. エラーハンドリング強化
   - Nemotron データ取得失敗時のフォールバック
   - Instagram API 制限時の対処
3. ドキュメント更新
   - `.claude/agents/001-persona-analyzer.md` (使用方法)
   - `README.md` (新機能説明)
   - `CHANGELOG.md` (変更履歴)

**ファイル**:
- `docs/nemotron_integration_guide.md`
- `CHANGELOG.md`

**成功基準**:
- ✅ 3 ケースで期待通りのペルソナ生成
- ✅ エラー時に適切なフォールバック動作
- ✅ ドキュメント完備

---

## 📊 品質評価基準

### ペルソナ品質指標
| 項目 | 現行 (Instagram のみ) | 改善後 (Nemotron + Instagram) |
|------|----------------------|-------------------------------|
| **年齢精度** | 推測ベース | 統計的裏付け ✅ |
| **職業精度** | ハッシュタグから推測 | 1,500+ カテゴリーから正確選定 ✅ |
| **居住地精度** | 不明確 | 47 都道府県から選定 ✅ |
| **文化的妥当性** | グローバルデータ混在 | 日本人口統計準拠 ✅ |
| **実在性** | 100% 実データ ✅ | Nemotron (合成) + Instagram (実) |
| **信頼性スコア** | N/A | 80-100 点で定量評価 ✅ |

### データ品質要件
- **Nemotron データ使用証明**: 抽出したペルソナの ID とフィールド値を記録
- **Instagram データ使用証明**: 既存の実アカウント名・投稿 ID 記録を継続
- **統合整合性**: 年齢・職業・趣味の矛盾がないこと
- **架空データ排除**: 引き続き 0% 架空データを維持

### パフォーマンス基準
- **Nemotron クエリ**: < 3 秒
- **Instagram API 呼び出し**: < 30 秒 (既存)
- **統合処理**: < 5 秒
- **Total E2E**: < 60 秒

---

## 🚧 実装時の注意事項

### Nemotron データセットの制約
1. **初回ダウンロード**: 1.73GB のダウンロードが必要 (初回のみ)
   - キャッシュ設定で 2 回目以降は高速化
2. **18 歳未満のペルソナなし**: ターゲットが 10 代の場合は Instagram のみにフォールバック
3. **言語**: 日本語のみ (グローバル市場には不適)

### Instagram API との統合
1. **ハッシュタグの日本語対応**: Nemotron の Occupation を日本語ハッシュタグに適切変換
2. **検索結果の精度**: キーワード生成ロジックの継続的調整が必要
3. **API 制限**: 既存の Apify 制限に加え、Nemotron クエリ処理時間を考慮

### 後方互換性
1. **既存フローの保持**: Instagram 直接検索も option として残す
   - 環境変数 `USE_NEMOTRON=false` で従来フロー実行可能
2. **出力フォーマット**: 既存の `persona_profiles.md` 形式を維持
3. **エージェント呼び出し**: `/persona` コマンドの引数は変更なし

---

## 🎯 段階的ロールアウト戦略

### Step 1: 実験的統合 (Week 1)
- Nemotron クエリ機能を別エージェントとして実装
- 既存 persona-analyzer と並行運用
- 5 ケースでの比較評価

### Step 2: ハイブリッド運用 (Week 2)
- persona-analyzer にオプション機能として統合
- `USE_NEMOTRON=true` で新フロー有効化
- ユーザーフィードバック収集

### Step 3: 本番切替 (Week 3)
- 評価結果を踏まえてデフォルト化
- ドキュメント最終版公開
- 旧フローは `--legacy` オプションで保持

---

## 📁 ファイル構成 (実装後)

```
.
├── .claude/
│   └── agents/
│       └── 001-persona-analyzer.md (更新)
├── lib/
│   ├── nemotron_persona_selector.py (新規)
│   ├── instagram_keyword_generator.py (新規)
│   └── persona_integrator.py (新規)
├── config/
│   └── keyword_mapping.json (新規)
├── tests/
│   ├── test_nemotron_selector.py (新規)
│   └── test_keyword_generator.py (新規)
├── docs/
│   └── nemotron_integration_guide.md (新規)
├── IMPLEMENTATION_PLAN.md (本ファイル)
└── CHANGELOG.md (更新)
```

---

## 🔄 代替案の検討

### Option A: Instagram のみ (現状維持)
**評価**: ❌ ターゲット精度の課題が未解決

### Option B: Nemotron のみ (Instagram 不使用)
**評価**: ❌ 実在データがなく、実際の悩み・トレンドが反映されない

### Option C: Nemotron + Instagram ハイブリッド (提案案)
**評価**: ✅ 統計的裏付け + 実在データの両立

### Option D: 他のペルソナデータセット利用
**候補**: Persona Hub, PersonaChat 等
**評価**: △ 日本市場特化がなく、文化的妥当性で劣る

---

## 📅 スケジュール見積もり

| Phase | 作業内容 | 所要時間 | 担当 |
|-------|---------|---------|------|
| 1 | 環境セットアップ | 1-2h | Dev |
| 2 | Nemotron クエリ開発 | 2-3h | Dev |
| 3 | Instagram キーワード生成 | 2-3h | Dev |
| 4 | エージェント統合 | 3-4h | Dev |
| 5 | 品質保証・ドキュメント | 2h | Dev + QA |
| **Total** | | **10-14h** | |

**実装開始**: ユーザー承認後
**完了予定**: 承認後 2-3 日以内

---

## ✅ 次のステップ

### ユーザー承認待ち項目
1. ✅ このアーキテクチャ案の承認
2. ✅ Nemotron-Personas-Japan データセット使用の承認
3. ✅ 新規依存関係 (`datasets` ライブラリ) の承認
4. ✅ 段階的ロールアウト計画の承認

### 承認後の即時アクション
1. Phase 1 環境セットアップ開始
2. Nemotron データセット初回ダウンロード
3. サンプルペルソナ生成テスト
4. ユーザーへの進捗報告

---

## 📝 備考・懸念事項

### 技術的懸念
- **データセットサイズ**: 1.73GB のストレージ消費
- **初回処理時間**: ダウンロード完了まで数分
- **依存関係追加**: Hugging Face エコシステムへの依存

### ビジネス的懸念
- **学習コスト**: 新フローの理解に時間が必要
- **複雑性増加**: デバッグが困難になる可能性
- **Instagram API 依存は継続**: Apify 制限の影響は変わらず

### 緩和策
- キャッシュ最適化でダウンロードは初回のみ
- 詳細ドキュメントとサンプルケース提供
- 旧フロー保持でリスク最小化

---

**計画作成者**: Claude (Sonnet 4.5)
**レビュー待ち**: ユーザー承認
**ブランチ**: `feature/improve-instagram-persona-analysis`
**関連 Issue**: N/A
